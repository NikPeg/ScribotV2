# База данных ScribotV2

## Обзор

База данных проекта ScribotV2 использует SQLite и управляется системой миграций. Все изменения схемы БД должны выполняться через миграции.

## Структура базы данных

### Таблица `users`

Хранит информацию о пользователях бота.

| Поле | Тип | Описание |
|------|-----|----------|
| `user_id` | INTEGER PRIMARY KEY | Telegram ID пользователя (используется как первичный ключ) |
| `created_at` | TIMESTAMP NOT NULL | Дата и время регистрации пользователя в боте |

**Особенности:**
- Пользователь создается автоматически при первом использовании команды `/start`
- Пользователь также создается автоматически при создании работы, если его еще нет в базе

### Таблица `works`

Хранит информацию о сгенерированных работах (курсовые, дипломные и т.д.).

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER PRIMARY KEY AUTOINCREMENT | Уникальный идентификатор работы |
| `user_id` | INTEGER NOT NULL | ID пользователя, создавшего работу (внешний ключ на `users.user_id`) |
| `theme` | TEXT NOT NULL | Тема работы |
| `pages` | INTEGER NOT NULL | Количество страниц |
| `work_type` | TEXT NOT NULL | Тип работы (курсовая, дипломная и т.д.) |
| `gpt_model` | TEXT NOT NULL | Модель GPT, использованная для генерации |
| `status` | TEXT NOT NULL | Текущий статус работы (created, in_progress, completed и т.д.) |
| `full_tex` | TEXT | Полный текст работы в формате LaTeX (может быть NULL) |
| `created_at` | TIMESTAMP NOT NULL | Дата и время создания заказа |

**Связи:**
- `user_id` → `users.user_id` (FOREIGN KEY) - каждая работа принадлежит одному пользователю

### Таблица `schema_version`

Служебная таблица для системы миграций. Хранит информацию о примененных миграциях.

| Поле | Тип | Описание |
|------|-----|----------|
| `version` | INTEGER PRIMARY KEY | Номер версии миграции |
| `applied_at` | TEXT NOT NULL | Дата и время применения миграции |

## Связи между таблицами

```
users (1) ────< (N) works
  │                    │
  │                    │
user_id            user_id (FK)
```

- **Один ко многим**: Один пользователь может создать множество работ
- **Обязательная связь**: Каждая работа должна принадлежать пользователю (NOT NULL + FOREIGN KEY)

## Система миграций

Все изменения схемы БД выполняются через миграции, расположенные в папке `db/migrations/`.

### Формат имени файла миграции

`NNN_description.sql`, где:
- `NNN` - порядковый номер миграции (001, 002, 003, ...)
- `description` - краткое описание миграции

### Применение миграций

Миграции применяются автоматически при старте приложения через функцию `init_db()` в `db/database.py`.

### Существующие миграции

1. **001_initial_schema.sql** - Создание начальной схемы БД (таблицы `users` и `works`)
2. **002_remove_openai_thread_id.sql** - Удаление поля `openai_thread_id` из таблицы `works`
3. **003_add_users_table.sql** - Добавление таблицы `users` и внешнего ключа в `works` (для существующих баз)

## Функции работы с БД

### Пользователи

- `get_or_create_user(user_id: int) -> bool` - Получает пользователя или создает нового. Возвращает `True`, если пользователь был создан.
- `user_exists(user_id: int) -> bool` - Проверяет существование пользователя в БД.

### Работы

- `create_order(user_id, theme, pages, work_type, gpt_model) -> int` - Создает новый заказ. Автоматически создает пользователя, если его нет.
- `update_order_status(order_id, status)` - Обновляет статус заказа.
- `save_full_tex(order_id, tex_content)` - Сохраняет полный LaTeX-текст работы.
- `get_order_info(order_id)` - Получает информацию о заказе.

## Инициализация БД

При первом запуске приложения вызывается `init_db()`, которая:
1. Применяет все непримененные миграции
2. Создает необходимые таблицы
3. Обновляет версию схемы в таблице `schema_version`

## Важные замечания

1. **Всегда используйте миграции** для изменения схемы БД. Не изменяйте таблицы напрямую.
2. **Проверяйте существование пользователя** перед созданием работы (функция `create_order` делает это автоматически).
3. **Внешние ключи** обеспечивают целостность данных - нельзя создать работу для несуществующего пользователя.
4. **Миграции идемпотентны** - их можно применять несколько раз без вреда.

## Расположение файлов

- `db/database.py` - Основные функции работы с БД
- `db/migration_manager.py` - Менеджер миграций
- `db/migrations/` - Папка с SQL-файлами миграций

