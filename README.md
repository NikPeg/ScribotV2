# ScribotV2

Telegram-бот для автоматической генерации студенческих работ (курсовых, дипломных, рефератов) с использованием языковых моделей. Бот создает уникальные работы на основе темы, выбранной пользователем, и предоставляет их в форматах PDF и DOCX.

## Основные возможности

- **Генерация работ**: Автоматическое создание студенческих работ по заданной теме
- **Выбор параметров**: Настройка объема работы (количество страниц), типа работы и модели LLM
- **Множество моделей**: Поддержка различных языковых моделей через OpenRouter API (Gemini, DeepSeek, GPT-4o-mini)
- **Форматы вывода**: Генерация работ в форматах LaTeX, PDF и DOCX
- **Система оплаты**: Интеграция с Telegram Stars для оплаты полной версии работы
- **Частичная версия**: Бесплатная отправка частичной версии работы с QR-кодами для оплаты
- **Проверка подписки**: Обязательная подписка на каналы перед генерацией (опционально)
- **Логирование**: Детальное логирование действий пользователей и запросов к LLM для администратора

## Архитектура проекта

### Основные модули

- **`main.py`** - Точка входа приложения, инициализация бота и диспетчера
- **`core/`** - Основная бизнес-логика:
  - `work_generator.py` - Оркестрация процесса генерации работы
  - `content_generator.py` - Генерация содержания через LLM с контролем объема
  - `document_converter.py` - Конвертация LaTeX в PDF и DOCX
  - `latex_template.py` - Создание LaTeX-документов
  - `page_calculator.py` - Расчет количества страниц и валидация плана
  - `settings.py` - Настройки приложения
  - `states.py` - Состояния FSM для обработки заказов
- **`gpt/`** - Работа с языковыми моделями:
  - `assistant.py` - Интеграция с OpenRouter API, управление историей разговоров
- **`handlers/`** - Обработчики команд и сообщений:
  - `common.py` - Общие команды (/start, /help, главное меню)
  - `order_handlers.py` - Обработка заказов на генерацию работ
  - `payment_handlers.py` - Обработка платежей через Telegram Stars
  - `subscription_handlers.py` - Проверка подписки на каналы
- **`db/`** - Работа с базой данных:
  - `database.py` - Основные функции для работы с БД
  - `migration_manager.py` - Система миграций базы данных
  - `migrations/` - SQL-миграции схемы БД
- **`services/`** - Вспомогательные сервисы:
  - `subscription_service.py` - Проверка подписки пользователей на каналы
- **`utils/`** - Утилиты:
  - `admin_logger.py` - Логирование действий для администратора
  - `llm_logger.py` - Логирование запросов к LLM
- **`keyboards/`** - Inline-клавиатуры для интерфейса бота

## Технологический стек

- **Python 3.11+**
- **aiogram 3.21** - Фреймворк для создания Telegram-ботов
- **OpenRouter API** - Доступ к различным языковым моделям
- **SQLite** - База данных (через aiosqlite)
- **LaTeX** - Генерация документов (pdflatex)
- **python-docx** - Работа с DOCX файлами
- **pypdf** - Работа с PDF файлами
- **reportlab** - Генерация QR-кодов в PDF
- **qrcode** - Создание QR-кодов
- **pydantic-settings** - Управление настройками

## Установка и настройка

### Требования

- Python 3.11 или выше
- LaTeX дистрибутив (для компиляции LaTeX в PDF)
- pdflatex в PATH

### Установка зависимостей

```bash
pip install -r requirements/requirements.txt
```

### Настройка переменных окружения

Создайте файл `.env` в корне проекта со следующими переменными:

```env
# Токен Telegram бота
BOT_TOKEN=your_telegram_bot_token

# Токен OpenRouter API для доступа к LLM
LLM_TOKEN=your_openrouter_api_key

# ID администратора (для получения логов)
ADMIN_ID=your_telegram_user_id

# URL канала для обратной связи
CHANNEL_URL=https://t.me/your_channel
FEEDBACK_URL=https://t.me/your_feedback_channel
SOS_URL=https://t.me/your_support_channel

# Обязательные каналы для подписки (разделенные запятыми)
# Формат: @channel1,@channel2 или channel_id1,channel_id2
REQUIRED_CHANNELS=

# Базовая цена в звездочках Telegram (по умолчанию 100)
BASE_PRICE=100

# Текст акции (опционально)
PROMOTION_TEXT=

# Уровень логирования для админа (all/none)
LOG_LEVEL=all
```

### Инициализация базы данных

База данных инициализируется автоматически при первом запуске. Миграции применяются автоматически через `migration_manager.py`.

## Запуск

### Локальный запуск

```bash
python main.py
```

### Запуск через Docker

```bash
cd deployment
docker-compose up -d
```

Подробнее о деплое см. [deployment/README.md](deployment/README.md)

## Процесс работы бота

1. **Создание заказа**: Пользователь отправляет тему работы или выбирает "Сгенерировать работу" в меню
2. **Выбор параметров**: 
   - Выбор объема работы (количество страниц)
   - Выбор типа работы (курсовая, дипломная, реферат и т.д.)
   - Выбор модели LLM
3. **Проверка подписки**: Если настроены обязательные каналы, проверяется подписка пользователя
4. **Генерация работы**:
   - Для малых работ (1-2 страницы): упрощенная генерация без плана и оглавления
   - Для больших работ: генерация плана, валидация плана, пошаговая генерация содержания по главам
5. **Создание документов**:
   - Генерация LaTeX-документа
   - Компиляция в PDF
   - Создание частичной версии PDF с QR-кодами для оплаты
6. **Отправка пользователю**: Частичная версия PDF отправляется бесплатно
7. **Оплата**: Пользователь может оплатить полную версию через Telegram Stars
8. **Отправка полной версии**: После оплаты генерируется и отправляется полная версия в PDF и DOCX

## Структура базы данных

### Таблица `users`
- `user_id` (INTEGER PRIMARY KEY) - ID пользователя Telegram
- `created_at` (TIMESTAMP) - Дата регистрации

### Таблица `works`
- `id` (INTEGER PRIMARY KEY) - ID заказа
- `user_id` (INTEGER) - ID пользователя (FK на users)
- `theme` (TEXT) - Тема работы
- `pages` (INTEGER) - Количество страниц
- `work_type` (TEXT) - Тип работы
- `gpt_model` (TEXT) - Использованная модель LLM
- `status` (TEXT) - Статус заказа (created, generating, completed, failed)
- `full_tex` (TEXT) - Полный LaTeX-код работы
- `created_at` (TIMESTAMP) - Дата создания заказа

## Система миграций

Проект использует систему миграций для управления схемой базы данных. Миграции находятся в `db/migrations/` и применяются автоматически при запуске приложения.

## Тестирование

Для запуска тестов:

```bash
pytest tests/
```

Проект включает тесты для:
- Генерации LaTeX-шаблонов
- Конвертации документов
- Валидации планов работ
- Миграций базы данных

## Логирование

### Логи LLM

Все запросы к языковым моделям логируются в `logs/llm_YYYY-MM-DD.log` с информацией о:
- ID заказа
- Использованной модели
- Промпте и ответе
- Времени выполнения
- Ошибках (если есть)

### Логи администратора

Действия пользователей отправляются администратору через Telegram с помощью `admin_logger.py`.

## Особенности реализации

### Генерация работ

- **Малые работы (1-2 страницы)**: Упрощенная генерация без плана и оглавления для ускорения процесса
- **Большие работы**: Полноценная генерация с планом, валидацией и пошаговым созданием содержания
- **Контроль объема**: Автоматический расчет количества страниц и адаптация генерации под целевой объем

### Конвертация документов

- **LaTeX → PDF**: Двухпроходная компиляция pdflatex для корректной генерации содержания и ссылок
- **LaTeX → DOCX**: Конвертация через pandoc с обработкой оглавления и форматирования
- **Частичный PDF**: Создание версии с водяными знаками и QR-кодами для оплаты

### Система оплаты

- Интеграция с Telegram Stars
- Pre-checkout валидация заказов
- Автоматическая генерация полной версии после оплаты
- Уведомления администратора об оплатах

## Документация

Дополнительная документация находится в папке `docs/`:
- `DOCX_GENERATION.md` - Детали генерации DOCX файлов
- `SYSTEM_REQUIREMENTS.md` - Системные требования
- `TROUBLESHOOTING.md` - Решение проблем
- `CI_CD_VARIABLES.md` - Переменные для CI/CD

## Разработка

### Форматирование кода

Проект использует `ruff` для форматирования и линтинга. Конфигурация находится в `pyproject.toml`.

```bash
ruff check .
ruff format .
```

### Структура проекта

Проект следует принципам модульной архитектуры с четким разделением ответственности:
- Обработчики событий в `handlers/`
- Бизнес-логика в `core/`
- Работа с внешними API в `gpt/`
- Утилиты и сервисы в соответствующих папках

## Переменные окружения

Полный список переменных окружения и их описание см. в `core/settings.py`.
