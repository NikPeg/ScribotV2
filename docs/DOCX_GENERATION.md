# Генерация DOCX файлов

Документация о том, как устроено создание DOCX файлов из LaTeX документов в проекте ScribotV2.

## Обзор

Процесс конвертации LaTeX в DOCX состоит из нескольких этапов:
1. Подготовка LaTeX контента
2. Конвертация через pandoc (основной метод)
3. Перемещение оглавления (TOC) после титульной страницы
4. Альтернативные методы конвертации (если pandoc недоступен)

## Используемые библиотеки

### Основные библиотеки

1. **python-docx** (`~=1.1.2`)
   - Работа с DOCX файлами
   - Чтение и модификация структуры документа
   - Перемещение элементов (TOC, параграфы)
   - Копирование форматирования

2. **pandoc** (внешняя утилита)
   - Конвертация LaTeX в DOCX
   - Генерация оглавления (TOC)
   - Сохранение структуры документа

### Вспомогательные библиотеки

3. **re** (стандартная библиотека Python)
   - Обработка регулярных выражений
   - Замена LaTeX команд (`\newpage`, `\tableofcontents`)

4. **asyncio** (стандартная библиотека Python)
   - Асинхронное выполнение команд pandoc
   - Управление подпроцессами

5. **contextlib** (стандартная библиотека Python)
   - Подавление исключений при работе с файлами
   - Управление ресурсами

## Процесс конвертации

### Основной метод: Pandoc

Основной метод конвертации использует **pandoc** для прямой конвертации LaTeX → DOCX.

#### Шаги конвертации:

1. **Подготовка LaTeX контента**
   ```python
   # Обрабатываем \newpage - заменяем на переносы строк
   modified_tex = re.sub(r'\\newpage\s*', '\n\n', tex_content)
   modified_tex = re.sub(r'\n\s*\n\s*\n+', '\n\n', modified_tex)
   ```

2. **Создание временного TEX файла**
   - LaTeX контент записывается во временный файл
   - Файл используется для конвертации через pandoc

3. **Запуск pandoc**
   ```bash
   pandoc input.tex -o output.docx \
     --from=latex \
     --to=docx \
     --toc \
     --toc-depth=3 \
     --wrap=none
   ```
   
   Параметры:
   - `--from=latex`: исходный формат LaTeX
   - `--to=docx`: целевой формат DOCX
   - `--toc`: генерировать оглавление
   - `--toc-depth=3`: глубина оглавления (3 уровня)
   - `--wrap=none`: не переносить строки

4. **Перемещение TOC после титульной страницы**
   - Pandoc всегда размещает TOC в начале документа
   - Функция `_move_toc_after_title_page()` перемещает TOC после титульной страницы

### Альтернативные методы

Если pandoc недоступен или не смог конвертировать, используются альтернативные методы:

1. **LibreOffice напрямую из TEX**
   - Конвертация через LibreOffice
   - Менее надежный метод, используется как fallback

2. **Через промежуточный PDF**
   - Сначала компилируется PDF из LaTeX
   - Затем PDF конвертируется в DOCX
   - ⚠️ **Проблема**: LibreOffice не может конвертировать PDF в ODT/DOCX напрямую

## Перемещение оглавления (TOC)

### Проблема

Pandoc с флагом `--toc` всегда размещает оглавление в начале документа, до титульной страницы. Для правильной структуры документа нужно переместить TOC после титульной страницы.

### Решение

Функция `_move_toc_after_title_page()` выполняет следующие действия:

1. **Поиск TOC в документе**
   - Проверка SDT элементов (structured document tags) - это специальные объекты Word для TOC
   - Поиск текста "Table of Contents" в параграфах

2. **Поиск титульной страницы**
   - Поиск текста "Проверил:" или "Петров П.П."
   - Определение границ титульной страницы

3. **Перемещение TOC**
   - Если TOC найден как SDT элемент:
     - Удаление SDT из текущей позиции
     - Вставка после элемента титульной страницы
   - Если TOC найден в параграфах:
     - Создание нового документа с правильным порядком
     - Копирование: титульная страница → TOC → основной контент

### Структура документа после перемещения

```
1. Титульная страница
   - МИНИСТЕРСТВО ОБРАЗОВАНИЯ И НАУКИ РФ
   - РОССИЙСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ
   - Тема работы
   - Выполнил/Проверил

2. Оглавление (TOC)
   - Table of Contents
   - Список разделов с номерами страниц

3. Основной контент
   - Разделы работы
   - Список использованных источников
```

## Обработка LaTeX команд

### `\newpage`

Команда `\newpage` заменяется на двойной перенос строки (`\n\n`), чтобы избежать появления текста "ewpage" в DOCX файле.

```python
modified_tex = re.sub(r'\\newpage\s*', '\n\n', tex_content)
```

### `\tableofcontents`

Команда `\tableofcontents` оставляется в LaTeX документе, чтобы pandoc мог создать TOC. Pandoc обрабатывает эту команду и создает SDT элемент с оглавлением.

## Обработка ошибок

### Ошибки конвертации

- Если pandoc не смог конвертировать, пробуются альтернативные методы
- Если все методы не сработали, возвращается ошибка с описанием проблемы

### Ошибки перемещения TOC

- Если TOC не найден, функция завершается с предупреждением
- Если титульная страница не найдена, TOC остается в начале документа
- Ошибки логируются, но не прерывают процесс конвертации

## Пример использования

```python
from core.document_converter import convert_tex_to_docx

# Конвертация LaTeX в DOCX
success, docx_path = await convert_tex_to_docx(
    tex_content=latex_content,
    output_dir="/tmp/output",
    filename="coursework"
)

if success:
    print(f"DOCX создан: {docx_path}")
else:
    print(f"Ошибка: {docx_path}")
```

## Требования

### Системные требования

- **pandoc** версии 3.6+ (рекомендуется)
- Python 3.12+
- Достаточно места на диске для временных файлов

### Python зависимости

```
python-docx~=1.1.2
```

## Известные ограничения

1. **Pandoc не всегда создает TOC**
   - Pandoc может не создать TOC из сложных LaTeX документов
   - В этом случае TOC может отсутствовать в DOCX файле

2. **Форматирование может отличаться**
   - Pandoc не всегда точно сохраняет форматирование LaTeX
   - Некоторые LaTeX команды могут быть неправильно обработаны

3. **LibreOffice не конвертирует PDF в DOCX**
   - Метод через промежуточный PDF не работает
   - LibreOffice не поддерживает конвертацию PDF в ODT/DOCX

## Отладка

### Логирование

Все этапы конвертации логируются:
- Подготовка LaTeX контента
- Запуск pandoc
- Перемещение TOC
- Ошибки и предупреждения

### Проверка результата

После конвертации можно проверить:
1. Наличие TOC в документе
2. Правильное расположение TOC (после титульной страницы)
3. Сохранение структуры документа
4. Отсутствие артефактов типа "ewpage"

## См. также

- [SYSTEM_REQUIREMENTS.md](SYSTEM_REQUIREMENTS.md) - системные требования
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - решение проблем
- [core/document_converter.py](../../core/document_converter.py) - исходный код

