# Генерация DOCX файлов

Документация о том, как устроено создание DOCX файлов из LaTeX документов в проекте ScribotV2.

## Обзор

Процесс конвертации LaTeX в DOCX состоит из нескольких этапов:
1. Подготовка LaTeX контента
2. Конвертация через pandoc (основной метод)
3. Перемещение оглавления (TOC) после титульной страницы
4. Альтернативные методы конвертации (если pandoc недоступен)

## Используемые библиотеки

### Основные библиотеки

1. **python-docx** (`~=1.1.2`)
   - Работа с DOCX файлами
   - Чтение и модификация структуры документа
   - Перемещение элементов (TOC, параграфы)
   - Копирование форматирования

2. **pandoc** (внешняя утилита)
   - Конвертация LaTeX в DOCX
   - Генерация оглавления (TOC)
   - Сохранение структуры документа

### Вспомогательные библиотеки

3. **re** (стандартная библиотека Python)
   - Обработка регулярных выражений
   - Замена LaTeX команд (`\newpage`, `\tableofcontents`)

4. **asyncio** (стандартная библиотека Python)
   - Асинхронное выполнение команд pandoc
   - Управление подпроцессами

5. **contextlib** (стандартная библиотека Python)
   - Подавление исключений при работе с файлами
   - Управление ресурсами

## Процесс конвертации

### Основной метод: Pandoc

Основной метод конвертации использует **pandoc** для прямой конвертации LaTeX → DOCX.

#### Шаги конвертации:

1. **Подготовка LaTeX контента**
   ```python
   # Обрабатываем \newpage - заменяем на переносы строк
   modified_tex = re.sub(r'\\newpage\s*', '\n\n', tex_content)
   modified_tex = re.sub(r'\n\s*\n\s*\n+', '\n\n', modified_tex)
   ```

2. **Создание временного TEX файла**
   - LaTeX контент записывается во временный файл
   - Файл используется для конвертации через pandoc

3. **Запуск pandoc**
   ```bash
   pandoc input.tex -o output.docx \
     --from=latex \
     --to=docx \
     --toc \
     --toc-depth=3 \
     --wrap=none
   ```
   
   Параметры:
   - `--from=latex`: исходный формат LaTeX
   - `--to=docx`: целевой формат DOCX
   - `--toc`: генерировать оглавление
   - `--toc-depth=3`: глубина оглавления (3 уровня)
   - `--wrap=none`: не переносить строки

4. **Перемещение TOC после титульной страницы**
   - Pandoc всегда размещает TOC в начале документа
   - Функция `_move_toc_after_title_page()` перемещает TOC после титульной страницы

5. **Добавление разрывов страниц**
   - После перемещения TOC функция `_add_page_breaks_to_docx()` добавляет разрывы страниц в нужных местах
   - Разрывы страниц добавляются:
     - После титульной страницы (перед TOC)
     - После TOC (перед первой главой)
     - Перед каждой новой главой (section)
   - Это обеспечивает правильную структуру документа, аналогичную PDF версии

### Альтернативные методы

Если pandoc недоступен или не смог конвертировать, используются альтернативные методы:

1. **LibreOffice напрямую из TEX**
   - Конвертация через LibreOffice
   - Менее надежный метод, используется как fallback

2. **Через промежуточный PDF**
   - Сначала компилируется PDF из LaTeX
   - Затем PDF конвертируется в DOCX
   - ⚠️ **Проблема**: LibreOffice не может конвертировать PDF в ODT/DOCX напрямую

## Перемещение оглавления (TOC)

### Проблема

Pandoc с флагом `--toc` всегда размещает оглавление в начале документа, до титульной страницы. Для правильной структуры документа нужно переместить TOC после титульной страницы.

### Решение

Функция `_move_toc_after_title_page()` выполняет следующие действия:

1. **Поиск TOC в документе**
   - Проверка SDT элементов (structured document tags) - это специальные объекты Word для TOC
   - Поиск текста "Table of Contents" в параграфах

2. **Поиск титульной страницы**
   - Поиск текста "Проверил:" или "Петров П.П."
   - Определение границ титульной страницы

3. **Перемещение TOC**
   - Если TOC найден как SDT элемент:
     - Удаление SDT из текущей позиции
     - Вставка после элемента титульной страницы
   - Если TOC найден в параграфах:
     - Создание нового документа с правильным порядком
     - Копирование: титульная страница → TOC → основной контент

### Структура документа после перемещения

```
1. Титульная страница
   - МИНИСТЕРСТВО ОБРАЗОВАНИЯ И НАУКИ РФ
   - РОССИЙСКИЙ ГОСУДАРСТВЕННЫЙ УНИВЕРСИТЕТ
   - Тема работы
   - Выполнил/Проверил
   [РАЗРЫВ СТРАНИЦЫ]

2. Оглавление (TOC)
   - Table of Contents
   - Список разделов с номерами страниц
   [РАЗРЫВ СТРАНИЦЫ]

3. Основной контент
   [РАЗРЫВ СТРАНИЦЫ]
   - Глава 1
   [РАЗРЫВ СТРАНИЦЫ]
   - Глава 2
   [РАЗРЫВ СТРАНИЦЫ]
   - Глава 3
   - Список использованных источников
```

**Примечание**: Каждая новая глава начинается с новой страницы благодаря добавленным разрывам страниц.

## Обработка LaTeX команд

### `\newpage`

Команда `\newpage` заменяется на двойной перенос строки (`\n\n`) при конвертации через pandoc, чтобы избежать появления текста "ewpage" в DOCX файле.

```python
modified_tex = re.sub(r'\\newpage\s*', '\n\n', tex_content)
```

**Важно**: После конвертации через pandoc разрывы страниц добавляются программно в нужных местах:
- После титульной страницы (перед TOC)
- После TOC (перед первой главой)
- Перед каждой новой главой (section)

Это обеспечивает правильную структуру документа, аналогичную PDF версии, где каждая новая глава начинается с новой страницы.

### `\tableofcontents`

Команда `\tableofcontents` оставляется в LaTeX документе, чтобы pandoc мог создать TOC. Pandoc обрабатывает эту команду и создает SDT элемент с оглавлением.

## Обработка ошибок

### Ошибки конвертации

- Если pandoc не смог конвертировать, пробуются альтернативные методы
- Если все методы не сработали, возвращается ошибка с описанием проблемы

### Ошибки перемещения TOC

- Если TOC не найден, функция завершается с предупреждением
- Если титульная страница не найдена, TOC остается в начале документа
- Ошибки логируются, но не прерывают процесс конвертации

## Пример использования

```python
from core.document_converter import convert_tex_to_docx

# Конвертация LaTeX в DOCX
success, docx_path = await convert_tex_to_docx(
    tex_content=latex_content,
    output_dir="/tmp/output",
    filename="coursework"
)

if success:
    print(f"DOCX создан: {docx_path}")
else:
    print(f"Ошибка: {docx_path}")
```

## Требования

### Системные требования

- **pandoc** версии 3.6+ (рекомендуется)
- Python 3.12+
- Достаточно места на диске для временных файлов

### Python зависимости

```
python-docx~=1.1.2
```

## Известные ограничения

1. **Pandoc не всегда создает TOC**
   - Pandoc может не создать TOC из сложных LaTeX документов
   - В этом случае TOC может отсутствовать в DOCX файле

2. **Форматирование может отличаться**
   - Pandoc не всегда точно сохраняет форматирование LaTeX
   - Некоторые LaTeX команды могут быть неправильно обработаны

3. **LibreOffice не конвертирует PDF в DOCX**
   - Метод через промежуточный PDF не работает
   - LibreOffice не поддерживает конвертацию PDF в ODT/DOCX

## Разрывы страниц

### Проблема

При конвертации LaTeX в DOCX через pandoc команда `\newpage` заменяется на перенос строки, что не создает разрыв страницы в DOCX файле. В результате все содержимое (титульный лист, TOC, главы) идет подряд без разрывов страниц.

### Решение

Функция `_add_page_breaks_to_docx()` программно добавляет разрывы страниц в нужных местах после конвертации. Функция вызывается автоматически после перемещения TOC в функции `_convert_tex_to_docx_direct()`.

### Алгоритм работы функции

Функция `_add_page_breaks_to_docx()` выполняет следующие шаги:

#### 1. Поиск ключевых элементов документа

**Поиск конца титульной страницы:**
- Ищет параграф с текстом "Проверил:" или "Петров П.П."
- Определяет последний параграф титульной страницы (может быть пустая строка после)

**Поиск TOC (оглавления):**
- Проверяет SDT элементы в body документа (pandoc создает TOC как SDT элемент)
- Ищет текст "Table of Contents", "Содержание" или "Оглавление" в параграфах
- Определяет границы TOC (начало и конец)

#### 2. Добавление разрыва страницы ПЕРЕД TOC

Если TOC найден:
- **Если TOC - SDT элемент**: создается новый параграф с разрывом страницы и вставляется перед SDT элементом в body через XML
- **Если TOC - обычный параграф**: разрыв страницы добавляется в начало первого run параграфа TOC через XML

```python
# Для SDT элемента
break_para_xml = '<w:p xmlns:w="..."><w:r><w:br w:type="page"/></w:r></w:p>'
break_para_elem = parse_xml(break_para_xml)
parent.insert(sdt_index, break_para_elem)

# Для обычного параграфа
break_xml = '<w:br xmlns:w="..." w:type="page"/>'
break_element = parse_xml(break_xml)
run_element.insert(0, break_element)
```

#### 3. Добавление разрыва страницы ПОСЛЕ TOC (перед первой главой)

Если TOC найден и определен его конец:
- Создается новый параграф с разрывом страницы перед первой главой
- Используется метод `insert_paragraph_before()` для вставки параграфа с разрывом

Если TOC не найден, но есть титульная страница:
- Ищется первая глава (заголовок с стилем "Heading" или текст, начинающийся с цифры)
- Добавляется разрыв страницы перед первой главой

#### 4. Добавление разрывов страниц перед каждой новой главой

Функция проходит по всем параграфам документа и определяет секции (главы) по следующим признакам:

1. **Стиль параграфа**: содержит "Heading" или "заголовок" в названии
2. **Паттерн номера**: текст начинается с номера секции (1., 2., и т.д.)
3. **Эвристика заголовка**: короткий текст (менее 100 символов), начинающийся с заглавной буквы, за которым следует длинный параграф (более 50 символов)

Для каждой найденной секции (кроме первой):
- Проверяется, нет ли уже разрыва страницы в начале параграфа
- Если разрыва нет, добавляется разрыв страницы в начало первого run через XML

### Определение секций

Функция определяет секции (главы) по следующим признакам:
- Стиль параграфа содержит "Heading" (pandoc создает заголовки с определенными стилями)
- Текст начинается с номера секции (1., 2., и т.д.) - паттерн `^\d+[.)]\s+[А-ЯЁA-Z]`
- Короткий текст (менее 100 символов), за которым следует длинный параграф (более 50 символов) - признак заголовка

### Реализация

Разрывы страниц добавляются двумя способами:

1. **Через XML напрямую** (предпочтительный метод):
```python
from docx.oxml import parse_xml

break_xml = '<w:br xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" w:type="page"/>'
break_element = parse_xml(break_xml)
run_element.insert(0, break_element)  # Вставка в начало run
```

2. **Через метод библиотеки** (для новых параграфов):
```python
from docx.enum.text import WD_BREAK

new_para = para.insert_paragraph_before()
new_para.add_run().add_break(WD_BREAK.PAGE)
```

### Порядок добавления разрывов

1. Разрыв ПЕРЕД TOC (после титульной страницы)
2. Разрыв ПОСЛЕ TOC (перед первой главой)
3. Разрывы перед каждой новой главой (начиная со второй)

### Проверка существующих разрывов

Перед добавлением разрыва страницы функция проверяет:
- Наличие разрыва страницы в начале параграфа (в первом run)
- Наличие разрыва страницы в предыдущем пустом параграфе

Это предотвращает дублирование разрывов страниц.

## Отладка

### Логирование

Все этапы конвертации логируются:
- Подготовка LaTeX контента
- Запуск pandoc
- Перемещение TOC
- Добавление разрывов страниц
- Ошибки и предупреждения

### Проверка результата

После конвертации можно проверить:
1. Наличие TOC в документе
2. Правильное расположение TOC (после титульной страницы)
3. Сохранение структуры документа
4. Отсутствие артефактов типа "ewpage"
5. Наличие разрывов страниц:
   - После титульной страницы (перед TOC)
   - После TOC (перед первой главой)
   - Перед каждой новой главой
6. Правильное количество страниц (каждая глава на новой странице)

## См. также

- [SYSTEM_REQUIREMENTS.md](SYSTEM_REQUIREMENTS.md) - системные требования
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - решение проблем
- [core/document_converter.py](../../core/document_converter.py) - исходный код

