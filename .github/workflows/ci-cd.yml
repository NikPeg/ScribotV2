name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: scribot-bot

jobs:
  lint:
    name: Run Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run Ruff
        run: |
          ruff check .

  build-and-test:
    name: Build Docker Image and Run Tests
    runs-on: ubuntu-latest
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å lint –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Yandex Container Registry
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/key.json
          cat /tmp/key.json | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex/${{ secrets.YC_REGISTRY_ID }}
          rm /tmp/key.json
      
      - name: Build Docker image (with tests)
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"
          # –°–æ–±–∏—Ä–∞–µ–º –¥–æ —ç—Ç–∞–ø–∞ test (—Ç–µ—Å—Ç—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
          docker build \
            --target test \
            --tag ${IMAGE_TAG}:test \
            -f deployment/Dockerfile .
      
      - name: Build and push production image
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"
          # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–¥–∞–∫—à–Ω –æ–±—Ä–∞–∑ (–∫—ç—à –∏–∑ test stage –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω)
          docker build \
            --target production \
            --tag ${IMAGE_TAG}:latest \
            --tag ${IMAGE_TAG}:${{ github.sha }} \
            -f deployment/Dockerfile .
          
          # –ü—É—à–∏–º –æ–±—Ä–∞–∑—ã
          docker push ${IMAGE_TAG}:latest
          docker push ${IMAGE_TAG}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    needs: [lint, build-and-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deployment/docker-compose.prod.yml,deployment/deploy.sh"
          target: "~/ScribotV2/"
          strip_components: 0
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_URL: ${{ secrets.CHAT_URL }}
          FEEDBACK_URL: ${{ secrets.FEEDBACK_URL }}
          SOS_URL: ${{ secrets.SOS_URL }}
          ADMIN_ID: ${{ secrets.ADMIN_ID }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL || 'all' }}
          REQUIRED_CHANNELS: ${{ secrets.REQUIRED_CHANNELS || '' }}
          BASE_PRICE: ${{ secrets.BASE_PRICE || '100' }}
          LLM_TOKEN: ${{ secrets.LLM_TOKEN }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
          YC_SA_JSON_CREDENTIALS: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          NEW_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
          BACKUP_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:stable
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: BOT_TOKEN,CHAT_URL,FEEDBACK_URL,SOS_URL,ADMIN_ID,LOG_LEVEL,REQUIRED_CHANNELS,BASE_PRICE,LLM_TOKEN,YC_REGISTRY_ID,YC_SA_JSON_CREDENTIALS,NEW_IMAGE,BACKUP_IMAGE
          script: |
            cd ~/ScribotV2/deployment
            chmod +x deploy.sh
            ./deploy.sh
      
      - name: Final verification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
            if sudo docker ps --filter name=scribot_bot --filter status=running | grep -q scribot_bot; then
              echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
              sudo docker ps --filter name=scribot_bot --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              sudo docker logs scribot_bot --tail=20
              echo ""
              echo "üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
              MIGRATION_LOG=$(sudo docker logs scribot_bot 2>&1 | grep -i "–º–∏–≥—Ä–∞—Ü–∏—è\|migration" | tail -5 || echo "")
              if [ -n "$MIGRATION_LOG" ]; then
                echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:"
                echo "$MIGRATION_LOG"
              else
                echo "‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö –≤ –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —Ä–∞–Ω–µ–µ)"
              fi
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
              ERROR_COUNT=$(sudo docker logs scribot_bot 2>&1 | grep -i "error\|exception\|traceback" | wc -l || echo "0")
              if [ "$ERROR_COUNT" -gt "0" ]; then
                echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
                sudo docker logs scribot_bot 2>&1 | grep -i "error\|exception\|traceback" | tail -10
              fi
            else
              echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              sudo docker logs scribot_bot --tail=50 2>&1 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
              exit 1
            fi
