name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: scribot-bot

# ‚ö†Ô∏è –í–ê–ñ–ù–û: –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç–µ:
# 1. –¢–µ—Å—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∏–∂–µ (–≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö: Run tests –∏ Test migrations)
# 2. env —Å–µ–∫—Ü–∏—é –≤ deploy job (—Å—Ç—Ä–æ–∫–∞ ~150) - –¥–ª—è –¥–µ–ø–ª–æ—è
# 3. envs —Å–ø–∏—Å–æ–∫ –≤ deploy job (—Å—Ç—Ä–æ–∫–∞ ~169) - –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ SSH
# –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. docs/CI_CD_VARIABLES.md
#
# –®–∞–±–ª–æ–Ω —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö (–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ –æ–±–∞ –º–µ—Å—Ç–∞ —Ç–µ—Å—Ç–æ–≤):
#   BOT_TOKEN: "test_token"
#   CHANNEL_URL: "https://test.channel.url"
#   FEEDBACK_URL: "https://test.feedback.url"
#   SOS_URL: "https://test.sos.url"
#   ADMIN_ID: "123456789"
#   LLM_TOKEN: "test_llm_token"

jobs:
  lint:
    name: Run Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run Ruff
        run: |
          ruff check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            poppler-utils \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-lang-cyrillic
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements/requirements-test.txt
      
      - name: Run tests
        # ‚ö†Ô∏è –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: –æ–±–Ω–æ–≤–∏—Ç–µ –∑–¥–µ—Å—å –∏ –≤ Test migrations –Ω–∏–∂–µ
        env:
          BOT_TOKEN: "test_token"
          CHANNEL_URL: "https://test.channel.url"
          FEEDBACK_URL: "https://test.feedback.url"
          SOS_URL: "https://test.sos.url"
          ADMIN_ID: "123456789"
          LLM_TOKEN: "test_llm_token"
        run: |
          pytest tests/ -v --tb=short
      
      - name: Test migrations
        # ‚ö†Ô∏è –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: –æ–±–Ω–æ–≤–∏—Ç–µ –∑–¥–µ—Å—å –∏ –≤ Run tests –≤—ã—à–µ
        env:
          BOT_TOKEN: "test_token"
          CHANNEL_URL: "https://test.channel.url"
          FEEDBACK_URL: "https://test.feedback.url"
          SOS_URL: "https://test.sos.url"
          ADMIN_ID: "123456789"
          LLM_TOKEN: "test_llm_token"
        run: |
          echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
          pytest tests/test_migrations.py -v --tb=short

  build-and-push:
    name: Build and Push Docker Image
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Yandex Container Registry
        run: |
          echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/key.json
          cat /tmp/key.json | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex/${{ secrets.YC_REGISTRY_ID }}
          rm /tmp/key.json
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"
          # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–¥–∞–∫—à–Ω –æ–±—Ä–∞–∑ (—Ç–µ—Å—Ç—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º job)
          docker build \
            --target production \
            --tag ${IMAGE_TAG}:latest \
            --tag ${IMAGE_TAG}:${{ github.sha }} \
            -f deployment/Dockerfile .
          
          docker push ${IMAGE_TAG}:latest
          docker push ${IMAGE_TAG}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deployment/docker-compose.prod.yml,deployment/deploy.sh"
          target: "~/ScribotV2/"
          strip_components: 0
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        # ‚ö†Ô∏è –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: –¥–æ–±–∞–≤—å—Ç–µ –µ—ë —Å—é–¥–∞, –≤ envs —Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ, –∏ –≤ x-test-env –≤—ã—à–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤)
        # –ü–æ–¥—Ä–æ–±–Ω–µ–µ —Å–º. docs/CI_CD_VARIABLES.md
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHANNEL_URL: ${{ secrets.CHANNEL_URL }}
          FEEDBACK_URL: ${{ secrets.FEEDBACK_URL }}
          SOS_URL: ${{ secrets.SOS_URL }}
          ADMIN_ID: ${{ secrets.ADMIN_ID }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL || 'all' }}
          REQUIRED_CHANNELS: ${{ secrets.REQUIRED_CHANNELS || '' }}
          BASE_PRICE: ${{ secrets.BASE_PRICE || '100' }}
          PROMOTION_TEXT: ${{ secrets.PROMOTION_TEXT || '' }}
          LLM_TOKEN: ${{ secrets.LLM_TOKEN }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
          YC_SA_JSON_CREDENTIALS: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          NEW_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
          BACKUP_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:stable
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # ‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–∞–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ env –≤—ã—à–µ (–∫—Ä–æ–º–µ NEW_IMAGE –∏ BACKUP_IMAGE - –æ–Ω–∏ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è)
          envs: BOT_TOKEN,CHANNEL_URL,FEEDBACK_URL,SOS_URL,ADMIN_ID,LOG_LEVEL,REQUIRED_CHANNELS,BASE_PRICE,PROMOTION_TEXT,LLM_TOKEN,YC_REGISTRY_ID,YC_SA_JSON_CREDENTIALS,NEW_IMAGE,BACKUP_IMAGE
          script: |
            cd ~/ScribotV2/deployment
            chmod +x deploy.sh
            ./deploy.sh
      
      - name: Final verification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
            if sudo docker ps --filter name=scribot_bot --filter status=running | grep -q scribot_bot; then
              echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
              sudo docker ps --filter name=scribot_bot --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              sudo docker logs scribot_bot --tail=20
              echo ""
              echo "üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö
              MIGRATION_LOG=$(sudo docker logs scribot_bot 2>&1 | grep -i "–º–∏–≥—Ä–∞—Ü–∏—è\|migration" | tail -5 || echo "")
              if [ -n "$MIGRATION_LOG" ]; then
                echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã:"
                echo "$MIGRATION_LOG"
              else
                echo "‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∏–≥—Ä–∞—Ü–∏—è—Ö –≤ –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (–≤–æ–∑–º–æ–∂–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –±—ã–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —Ä–∞–Ω–µ–µ)"
              fi
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
              ERROR_COUNT=$(sudo docker logs scribot_bot 2>&1 | grep -i "error\|exception\|traceback" | wc -l || echo "0")
              if [ "$ERROR_COUNT" -gt "0" ]; then
                echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
                sudo docker logs scribot_bot 2>&1 | grep -i "error\|exception\|traceback" | tail -10
              fi
            else
              echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              sudo docker logs scribot_bot --tail=50 2>&1 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
              exit 1
            fi
