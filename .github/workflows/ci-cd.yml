name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: scribot-bot

jobs:
  lint:
    name: Run Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run Ruff
        run: |
          ruff check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            poppler-utils \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-lang-cyrillic
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run tests
        env:
          BOT_TOKEN: "test_token"
          CHAT_URL: "https://test.chat.url"
          FEEDBACK_URL: "https://test.feedback.url"
          SOS_URL: "https://test.sos.url"
          ADMIN_ID: "123456789"
          LLM_TOKEN: "test_llm_token"
        run: |
          pytest tests/ -v --tb=short || python -m unittest discover tests -v

  build-and-push:
    name: Build and Push Docker Image
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Yandex Container Registry
        run: |
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON –∫–ª—é—á –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/key.json
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –∏—Å–ø–æ–ª—å–∑—É—è docker
          cat /tmp/key.json | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex/${{ secrets.YC_REGISTRY_ID }}
          # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
          rm /tmp/key.json
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"
          # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
          docker build -t ${IMAGE_TAG}:latest -t ${IMAGE_TAG}:${{ github.sha }} -f deployment/Dockerfile .
          # –ü—É—à–∏–º –æ–±–∞ —Ç–µ–≥–∞
          docker push ${IMAGE_TAG}:latest
          docker push ${IMAGE_TAG}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy docker-compose.prod.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deployment/docker-compose.prod.yml"
          target: "~/ScribotV2/deployment/"
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_URL: ${{ secrets.CHAT_URL }}
          FEEDBACK_URL: ${{ secrets.FEEDBACK_URL }}
          SOS_URL: ${{ secrets.SOS_URL }}
          ADMIN_ID: ${{ secrets.ADMIN_ID }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL || 'all' }}
          REQUIRED_CHANNELS: ${{ secrets.REQUIRED_CHANNELS || '' }}
          LLM_TOKEN: ${{ secrets.LLM_TOKEN }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
          NEW_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
          BACKUP_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:stable
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: BOT_TOKEN,CHAT_URL,FEEDBACK_URL,SOS_URL,ADMIN_ID,LOG_LEVEL,REQUIRED_CHANNELS,LLM_TOKEN,YC_REGISTRY_ID,NEW_IMAGE,BACKUP_IMAGE
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π..."
            
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            export DEPLOY_DIR="$HOME/ScribotV2"
            export DEPLOYMENT_DIR="$DEPLOY_DIR/deployment"
            mkdir -p "$DEPLOY_DIR/data" "$DEPLOY_DIR/logs" "$DEPLOYMENT_DIR"
            echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–µ–ø–ª–æ—è: $DEPLOY_DIR"
            echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è deployment: $DEPLOYMENT_DIR"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker-compose.prod.yml –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            if [ ! -f "$DEPLOYMENT_DIR/docker-compose.prod.yml" ]; then
              echo "‚ö†Ô∏è  –§–∞–π–ª docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
              ls -la "$DEPLOYMENT_DIR" || true
              echo "–ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª..."
              find "$HOME" -name "docker-compose.prod.yml" -type f 2>/dev/null || true
              echo "‚ùå –û—à–∏–±–∫–∞: docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω –∫–∞–∫ —Ñ–∞–π–ª!"
              exit 1
            else
              echo "‚úÖ –§–∞–π–ª docker-compose.prod.yml –Ω–∞–π–¥–µ–Ω –≤ $DEPLOYMENT_DIR"
            fi
            
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Yandex Container Registry
            echo "üîê –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Yandex Container Registry..."
            echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/key.json
            cat /tmp/key.json | sudo docker login \
              --username json_key \
              --password-stdin \
              cr.yandex/${{ secrets.YC_REGISTRY_ID }}
            rm /tmp/key.json
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ä–∞–±–æ—Ç–∞—é—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            CURRENT_IMAGE=""
            if sudo docker ps --filter name=scribot_bot --format "{{.Image}}" | grep -q .; then
              CURRENT_IMAGE=$(sudo docker ps --filter name=scribot_bot --format "{{.Image}}")
              echo "üì∏ –¢–µ–∫—É—â–∏–π –æ–±—Ä–∞–∑: $CURRENT_IMAGE"
              # –¢–µ–≥–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π –æ–±—Ä–∞–∑ –∫–∞–∫ stable (—Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è)
              sudo docker tag "$CURRENT_IMAGE" "$BACKUP_IMAGE" || echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å backup —Ç–µ–≥"
            else
              echo "‚ö†Ô∏è  –¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"
            fi
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
            echo "‚¨áÔ∏è  –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑..."
            sudo docker pull "$NEW_IMAGE"
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "‚è∏Ô∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
            
            # –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ docker-compose, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ –Ω–µ–≥–æ
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞: prod –∏ –æ–±—ã—á–Ω—ã–π (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ docker-compose.yml)
            if [ -f "$DEPLOYMENT_DIR/docker-compose.prod.yml" ]; then
              echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ docker-compose.prod.yml..."
              cd "$DEPLOYMENT_DIR" || true
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ docker-compose (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
              sudo docker-compose -f docker-compose.prod.yml down --remove-orphans --timeout 30 2>/dev/null || true
              sleep 3
              # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É–¥–∞–ª—è–µ–º, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å
              sudo docker-compose -f docker-compose.prod.yml rm -f 2>/dev/null || true
              sleep 2
            fi
            
            # –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–π docker-compose.yml (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ã–ª –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ –Ω–µ–≥–æ)
            if [ -f "$DEPLOYMENT_DIR/docker-compose.yml" ]; then
              echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ docker-compose.yml (—Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª)..."
              cd "$DEPLOYMENT_DIR" || true
              sudo docker-compose -f docker-compose.yml down --remove-orphans --timeout 10 2>/dev/null || true
              sleep 2
            fi
            
            # –ü–æ–ª—É—á–∞–µ–º ID –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∏–º–µ–Ω–µ–º scribot_bot (–≤–∫–ª—é—á–∞—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ)
            CONTAINER_IDS=$(sudo docker ps -a --filter name=scribot_bot --format "{{.ID}}" || true)
            
            if [ -n "$CONTAINER_IDS" ]; then
              echo "üóëÔ∏è  –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: $CONTAINER_IDS"
              for CONTAINER_ID in $CONTAINER_IDS; do
                echo "  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_ID..."
                
                # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
                echo "  –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –¥–ª—è $CONTAINER_ID..."
                sudo docker update --restart=no "$CONTAINER_ID" 2>/dev/null || true
                
                # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                echo "  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_ID..."
                sudo docker stop --timeout 10 "$CONTAINER_ID" 2>/dev/null || true
                sleep 2
                
                # –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º docker kill (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
                CONTAINER_STATUS=$(sudo docker inspect "$CONTAINER_ID" --format '{{.State.Status}}' 2>/dev/null || echo "unknown")
                if [ "$CONTAINER_STATUS" = "running" ]; then
                  echo "  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º docker kill..."
                  sudo docker kill "$CONTAINER_ID" 2>/dev/null || true
                  sleep 2
                fi
                
                # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CONTAINER_ID..."
                sudo docker rm -f "$CONTAINER_ID" 2>/dev/null || true
                sleep 1
              done
              sleep 3
            fi
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã
            if sudo docker ps -a --filter name=scribot_bot --format "{{.Names}}" | grep -q scribot_bot; then
              echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–º–µ–Ω—è–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã..."
              
              # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ docker –∫–æ–º–∞–Ω–¥—ã
              REMAINING_IDS=$(sudo docker ps -a --filter name=scribot_bot --format "{{.ID}}")
              for CONTAINER_ID in $REMAINING_IDS; do
                echo "  –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_ID..."
                
                # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
                sudo docker update --restart=no "$CONTAINER_ID" 2>/dev/null || true
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º docker kill (–±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ —á–µ–º stop)
                sudo docker kill "$CONTAINER_ID" 2>/dev/null || true
                sleep 2
                
                # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—â–µ —Ä–∞–∑
                sudo docker stop --timeout 5 "$CONTAINER_ID" 2>/dev/null || true
                sleep 2
                
                # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
                echo "  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $CONTAINER_ID..."
                sudo docker rm -f "$CONTAINER_ID" 2>/dev/null || true
                sleep 2
              done
              
              # –§–∏–Ω–∞–ª—å–Ω–∞—è-—Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
              if sudo docker ps -a --filter name=scribot_bot --format "{{.Names}}" | grep -q scribot_bot; then
                echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-–∑–æ–º–±–∏ –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –£–±–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ PID..."
                
                # –ü–æ–ª—É—á–∞–µ–º PID –∏ —É–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞–ø—Ä—è–º—É—é (—ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–≥–¥–∞ docker daemon –Ω–µ –º–æ–∂–µ—Ç)
                ZOMBIE_IDS=$(sudo docker ps -a --filter name=scribot_bot --format "{{.ID}}")
                for ZOMBIE_ID in $ZOMBIE_IDS; do
                  echo "  üî™ –ü–æ–ª—É—á–∞–µ–º PID –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ $ZOMBIE_ID..."
                  CONTAINER_PID=$(sudo docker inspect "$ZOMBIE_ID" --format '{{.State.Pid}}' 2>/dev/null || echo "0")
                  
                  if [ "$CONTAINER_PID" != "0" ] && [ -n "$CONTAINER_PID" ]; then
                    echo "  üíÄ –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å $CONTAINER_PID —á–µ—Ä–µ–∑ kill -9..."
                    sudo kill -9 "$CONTAINER_PID" 2>/dev/null || true
                    sleep 3
                  fi
                  
                  # –ü—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
                  echo "  üóëÔ∏è  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $ZOMBIE_ID..."
                  sudo docker rm -f "$ZOMBIE_ID" 2>/dev/null || true
                  sleep 1
                done
                
                # –ï—â—ë –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
                if sudo docker ps -a --filter name=scribot_bot --format "{{.Names}}" | grep -q scribot_bot; then
                  echo "‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–æ—Å–ª–µ kill -9, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker..."
                  
                  # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Docker daemon –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ
                  echo "  üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Docker daemon..."
                  sudo systemctl restart docker 2>/dev/null || sudo service docker restart 2>/dev/null || true
                  sleep 5
                  
                  # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
                  FINAL_IDS=$(sudo docker ps -a --filter name=scribot_bot --format "{{.ID}}")
                  for FINAL_ID in $FINAL_IDS; do
                    sudo docker rm -f "$FINAL_ID" 2>/dev/null || true
                  done
                  sleep 2
                  
                  # –ê–±—Å–æ–ª—é—Ç–Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                  if sudo docker ps -a --filter name=scribot_bot --format "{{.Names}}" | grep -q scribot_bot; then
                    echo "‚ùå –ù–ï–í–û–ó–ú–û–ñ–ù–û –£–î–ê–õ–ò–¢–¨ –ö–û–ù–¢–ï–ô–ù–ï–† –¥–∞–∂–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Docker!"
                    echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
                    sudo docker ps -a --filter name=scribot_bot
                    exit 1
                  fi
                fi
              fi
            fi
            
            echo "‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã"
            
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ docker-compose
            start_container() {
              echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ docker-compose..."
              
              # –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–±–∏—Ç
              OLD_CONTAINERS=$(sudo docker ps -a --filter name=scribot_bot --format "{{.ID}}" || true)
              if [ -n "$OLD_CONTAINERS" ]; then
                echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –æ—Å—Ç–∞—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤, —É–¥–∞–ª—è–µ–º..."
                for CID in $OLD_CONTAINERS; do
                  echo "  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $CID..."
                  # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
                  sudo docker update --restart=no "$CID" 2>/dev/null || true
                  # –ò—Å–ø–æ–ª—å–∑—É–µ–º docker kill –¥–ª—è –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                  sudo docker kill "$CID" 2>/dev/null || true
                  sleep 1
                  # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                  sudo docker rm -f "$CID" 2>/dev/null || true
                done
                sleep 2
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker-compose.prod.yml
              if [ ! -f "$DEPLOYMENT_DIR/docker-compose.prod.yml" ]; then
                echo "‚ùå –§–∞–π–ª docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $DEPLOYMENT_DIR"
                echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
                ls -la "$DEPLOYMENT_DIR" || true
                return 1
              fi
              
              # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ deployment, —Ä—è–¥–æ–º —Å docker-compose.prod.yml)
              echo "üìù –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
              {
                echo "BOT_TOKEN=$BOT_TOKEN"
                echo "CHAT_URL=$CHAT_URL"
                echo "FEEDBACK_URL=$FEEDBACK_URL"
                echo "SOS_URL=$SOS_URL"
                echo "ADMIN_ID=$ADMIN_ID"
                echo "LOG_LEVEL=$LOG_LEVEL"
                echo "REQUIRED_CHANNELS=$REQUIRED_CHANNELS"
                echo "LLM_TOKEN=$LLM_TOKEN"
                echo "YC_REGISTRY_ID=$YC_REGISTRY_ID"
                echo "NEW_IMAGE=$NEW_IMAGE"
              } > "$DEPLOYMENT_DIR/.env"
              
              # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ docker-compose
              cd "$DEPLOYMENT_DIR" || return 1
              echo "üìÇ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
              echo "üìÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤:"
              ls -la docker-compose.prod.yml .env || true
              sudo docker-compose -f docker-compose.prod.yml up -d
            }
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            echo "üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑: $NEW_IMAGE"
            if start_container; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"
              exit 1
            fi
            
            # –ñ–¥–µ–º –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞–Ω–µ—Ç healthy (–º–∞–∫—Å–∏–º—É–º 60 —Å–µ–∫—É–Ω–¥)
            echo "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ healthcheck (–¥–æ 60 —Å–µ–∫—É–Ω–¥)..."
            HEALTH_CHECK_TIMEOUT=60
            HEALTH_CHECK_INTERVAL=5
            ELAPSED=0
            
            while [ $ELAPSED -lt $HEALTH_CHECK_TIMEOUT ]; do
              HEALTH_STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' scribot_bot 2>/dev/null || echo "none")
              
              if [ "$HEALTH_STATUS" = "healthy" ]; then
                echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–¥–æ—Ä–æ–≤ (healthy)"
                break
              elif [ "$HEALTH_STATUS" = "none" ]; then
                # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–µ–∑ healthcheck –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω
                if sudo docker ps --filter name=scribot_bot --filter status=running | grep -q scribot_bot; then
                  echo "‚ÑπÔ∏è  –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (healthcheck –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)"
                  break
                else
                  echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
                  break
                fi
              else
                echo "‚è≥ –°—Ç–∞—Ç—É—Å: $HEALTH_STATUS (–ø—Ä–æ—à–ª–æ ${ELAPSED}—Å)"
                sleep $HEALTH_CHECK_INTERVAL
                ELAPSED=$((ELAPSED + HEALTH_CHECK_INTERVAL))
              fi
            done
            
            # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            FINAL_HEALTH_STATUS=$(sudo docker inspect --format='{{.State.Health.Status}}' scribot_bot 2>/dev/null || echo "none")
            CONTAINER_RUNNING=$(sudo docker ps --filter name=scribot_bot --filter status=running | grep -q scribot_bot && echo "yes" || echo "no")
            
            if [ "$FINAL_HEALTH_STATUS" != "healthy" ] && [ "$FINAL_HEALTH_STATUS" != "none" ]; then
              echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø—Ä–æ—à–µ–ª healthcheck –∑–∞ ${HEALTH_CHECK_TIMEOUT} —Å–µ–∫—É–Ω–¥!"
              echo "–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å: $FINAL_HEALTH_STATUS"
              sudo docker logs scribot_bot --tail=50
              
              # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
              if [ -n "$CURRENT_IMAGE" ]; then
                echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å healthcheck"
                
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ docker –∫–æ–º–∞–Ω–¥—ã
                sudo docker update --restart=no scribot_bot 2>/dev/null || true
                sudo docker kill scribot_bot 2>/dev/null || true
                sleep 1
                sudo docker stop scribot_bot 2>/dev/null || true
                sudo docker rm -f scribot_bot 2>/dev/null || true
                
                # –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º backup –æ–±—Ä–∞–∑ –∫–∞–∫ latest –¥–ª—è docker-compose
                echo "üì¶ –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º $BACKUP_IMAGE -> $NEW_IMAGE"
                sudo docker tag "$BACKUP_IMAGE" "$NEW_IMAGE" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Ç–µ–≥–∏—Ä–æ–≤–∞—Ç—å"
                
                start_container
                sleep 10
                echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
                sudo docker logs scribot_bot --tail=30
                exit 1
              else
                echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                exit 1
              fi
            fi
            
            if [ "$CONTAINER_RUNNING" = "yes" ]; then
              echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
              LOGS=$(sudo docker logs scribot_bot 2>&1 | tail -100)
              if echo "$LOGS" | grep -iE "CRITICAL|ERROR.*Failed to|Exception.*startup|‚ùå"; then
                echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö!"
                
                # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
                if [ -n "$CURRENT_IMAGE" ]; then
                  echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏: $CURRENT_IMAGE"
                  
                  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ docker –∫–æ–º–∞–Ω–¥—ã
                  sudo docker update --restart=no scribot_bot 2>/dev/null || true
                  sudo docker kill scribot_bot 2>/dev/null || true
                  sleep 1
                  sudo docker stop scribot_bot 2>/dev/null || true
                  sudo docker rm -f scribot_bot 2>/dev/null || true
                  
                  # –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º backup –æ–±—Ä–∞–∑ –∫–∞–∫ latest –¥–ª—è docker-compose
                  echo "üì¶ –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º $BACKUP_IMAGE -> $NEW_IMAGE"
                  sudo docker tag "$BACKUP_IMAGE" "$NEW_IMAGE" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Ç–µ–≥–∏—Ä–æ–≤–∞—Ç—å"
                  
                  start_container
                  sleep 10
                  echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
                  sudo docker logs scribot_bot --tail=30
                  exit 1
                else
                  echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                  sudo docker logs scribot_bot --tail=50
                  exit 1
                fi
              else
                echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!"
                sudo docker logs scribot_bot --tail=30
                echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
                sudo docker ps --filter name=scribot_bot
              fi
            else
              echo "‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              
              # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
              if [ -n "$CURRENT_IMAGE" ]; then
                echo "üîô –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏: $CURRENT_IMAGE"
                
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —á–µ—Ä–µ–∑ docker –∫–æ–º–∞–Ω–¥—ã
                sudo docker update --restart=no scribot_bot 2>/dev/null || true
                sudo docker kill scribot_bot 2>/dev/null || true
                sleep 1
                sudo docker stop scribot_bot 2>/dev/null || true
                sudo docker rm -f scribot_bot 2>/dev/null || true
                
                # –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º backup –æ–±—Ä–∞–∑ –∫–∞–∫ latest –¥–ª—è docker-compose
                echo "üì¶ –ü–µ—Ä–µ—Ç–µ–≥–∏—Ä—É–µ–º $BACKUP_IMAGE -> $NEW_IMAGE"
                sudo docker tag "$BACKUP_IMAGE" "$NEW_IMAGE" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Ç–µ–≥–∏—Ä–æ–≤–∞—Ç—å"
                
                start_container
                sleep 10
                echo "üîÑ –û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω"
                sudo docker logs scribot_bot --tail=30
              else
                echo "‚ö†Ô∏è  –ù–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–∫–∞—Ç–∞!"
                sudo docker logs scribot_bot --tail=50
              fi
              exit 1
            fi
      
      - name: Final verification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
            if sudo docker ps --filter name=scribot_bot --filter status=running | grep -q scribot_bot; then
              echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
              echo ""
              echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:"
              sudo docker ps --filter name=scribot_bot --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              sudo docker logs scribot_bot --tail=20
            else
              echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              sudo docker logs scribot_bot --tail=50 2>&1 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
              exit 1
            fi


