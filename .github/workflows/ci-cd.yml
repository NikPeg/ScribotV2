name: CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: cr.yandex
  IMAGE_NAME: scribot-bot

jobs:
  lint:
    name: Run Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff
      
      - name: Run Ruff
        run: |
          ruff check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            poppler-utils \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-lang-cyrillic
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run tests
        env:
          BOT_TOKEN: "test_token"
          CHAT_URL: "https://test.chat.url"
          FEEDBACK_URL: "https://test.feedback.url"
          SOS_URL: "https://test.sos.url"
          ADMIN_ID: "123456789"
          LLM_TOKEN: "test_llm_token"
        run: |
          pytest tests/ -v --tb=short || python -m unittest discover tests -v

  build-and-push:
    name: Build and Push Docker Image
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Login to Yandex Container Registry
        run: |
          echo '${{ secrets.YC_SA_JSON_CREDENTIALS }}' > /tmp/key.json
          cat /tmp/key.json | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex/${{ secrets.YC_REGISTRY_ID }}
          rm /tmp/key.json
      
      - name: Build and push Docker image
        run: |
          IMAGE_TAG="${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}"
          docker build -t ${IMAGE_TAG}:latest -t ${IMAGE_TAG}:${{ github.sha }} -f deployment/Dockerfile .
          docker push ${IMAGE_TAG}:latest
          docker push ${IMAGE_TAG}:${{ github.sha }}

  deploy:
    name: Deploy to Server
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "deployment/docker-compose.prod.yml,deployment/deploy.sh"
          target: "~/ScribotV2/"
          strip_components: 0
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_URL: ${{ secrets.CHAT_URL }}
          FEEDBACK_URL: ${{ secrets.FEEDBACK_URL }}
          SOS_URL: ${{ secrets.SOS_URL }}
          ADMIN_ID: ${{ secrets.ADMIN_ID }}
          LOG_LEVEL: ${{ secrets.LOG_LEVEL || 'all' }}
          REQUIRED_CHANNELS: ${{ secrets.REQUIRED_CHANNELS || '' }}
          LLM_TOKEN: ${{ secrets.LLM_TOKEN }}
          YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
          YC_SA_JSON_CREDENTIALS: ${{ secrets.YC_SA_JSON_CREDENTIALS }}
          NEW_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
          BACKUP_IMAGE: ${{ env.REGISTRY }}/${{ secrets.YC_REGISTRY_ID }}/${{ env.IMAGE_NAME }}:stable
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: BOT_TOKEN,CHAT_URL,FEEDBACK_URL,SOS_URL,ADMIN_ID,LOG_LEVEL,REQUIRED_CHANNELS,LLM_TOKEN,YC_REGISTRY_ID,YC_SA_JSON_CREDENTIALS,NEW_IMAGE,BACKUP_IMAGE
          script: |
            cd ~/ScribotV2/deployment
            chmod +x deploy.sh
            ./deploy.sh
      
      - name: Final verification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.YC_INSTANCE_IP }}
          username: ${{ secrets.YC_INSTANCE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
            if sudo docker ps --filter name=scribot_bot --filter status=running | grep -q scribot_bot; then
              echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
              sudo docker ps --filter name=scribot_bot --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
              echo ""
              echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
              sudo docker logs scribot_bot --tail=10
            else
              echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              sudo docker logs scribot_bot --tail=30 2>&1 || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
              exit 1
            fi
