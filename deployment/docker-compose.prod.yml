services:
  bot:
    image: ${NEW_IMAGE}
    container_name: scribot_bot
    restart: unless-stopped
    environment:
      # Указываем путь к директории с базой данных
      - DB_DIR=/app/data
      # Указываем путь к директории для логов LLM
      - LLM_LOG_DIR=/app/logs
      # Переменные окружения из .env (pydantic-settings автоматически преобразует UPPER_CASE в snake_case)
      - BOT_TOKEN=${BOT_TOKEN}
      - CHAT_URL=${CHAT_URL}
      - FEEDBACK_URL=${FEEDBACK_URL}
      - SOS_URL=${SOS_URL}
      - ADMIN_ID=${ADMIN_ID}
      - LOG_LEVEL=${LOG_LEVEL:-all}
      - REQUIRED_CHANNELS=${REQUIRED_CHANNELS:-}
      - BASE_PRICE=${BASE_PRICE:-100}
      - LLM_TOKEN=${LLM_TOKEN}
    volumes:
      # Монтируем директорию с базой данных с хоста, чтобы она сохранялась между запусками
      # Используем ../data так как docker-compose запускается из deployment/
      - ../data:/app/data
      # Монтируем директорию для логов LLM с хоста
      - ../logs:/app/logs
    working_dir: /app
    # Убеждаемся, что контейнер не завершается при ошибках
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

